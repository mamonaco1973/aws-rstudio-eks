# ==============================================================================
# RStudio App - Combined Kubernetes Manifest (Secrets Mounted as Files)
# ------------------------------------------------------------------------------
# This manifest deploys an RStudio Server container into a Kubernetes cluster,
# configured to authenticate users through Active Directory (AD) using SSSD.
# It defines:
#   1. A Secret containing configuration parameters (admin_secret, domain_fqdn, region)
#   2. A PersistentVolumeClaim backed by EFS for shared home directories
#   3. A Deployment for the RStudio container with Secret mounted as files
#   4. A Service for internal cluster access
#   5. An ALB Ingress for external access over HTTP
#   6. A Horizontal Pod Autoscaler (HPA) that scales based on CPU utilization
# ==============================================================================
# --- StorageClass for EFS (Static Provisioning) -------------------------------
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: efs.csi.aws.com
mountOptions:
  - tls
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
# Notes:
# - No 'parameters' block — this disables dynamic provisioning.
# - EFS PVs must be defined manually (static provisioning).

---
# --- PersistentVolume for EFS Filesystem -------------------------------------
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-pv
spec:
  capacity:
    storage: 1Ti
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sc
  mountOptions:
    - tls
  csi:
    driver: efs.csi.aws.com
    volumeHandle: ${efs_id}               # Replace with your actual EFS ID
---
# --- Secret: RStudio Configuration -------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: rstudio-config                     # Name used to reference this secret
type: Opaque                               # Standard type for arbitrary key-value data
stringData:
  admin_secret: "${admin_secret}"          # Name of AWS Secrets Manager secret holding AD admin creds
  domain_fqdn: "${domain_fqdn}"            # Fully Qualified Domain Name (FQDN) of AD domain to join
  region: "us-east-1"                      # AWS region for Secrets Manager API calls
# Notes:
# - The values here are low sensitivity; true credentials are stored in AWS Secrets Manager.
# - These keys are mounted as text files inside the container, not as environment vars,
#   reducing risk of exposure through 'kubectl describe pod' or /proc.
---
# --- PersistentVolumeClaim (EFS) ---------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-claim                          # PVC name referenced in the Deployment
spec:
  accessModes:
    - ReadWriteMany                        # Allows multiple pods to share the same volume
  storageClassName: efs-sc                 # StorageClass provisioned by AWS EFS CSI driver
  resources:
    requests:
      storage: 1Gi                         # Minimum size (logical request, not quota-enforcing for EFS)
# Notes:
# - This PVC provides shared /home-style storage persisted in EFS.
# - Allows users’ home directories and R libraries to persist across container restarts.
---
# --- Deployment ---------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rstudio                            # Deployment name (unique within namespace)
  labels:
    app: rstudio                           # Common label for selector and grouping
spec:
  replicas: 2                              # Initial number of RStudio Server pods
  selector:
    matchLabels:
      app: rstudio                         # Selector matching the pod template
  template:
    metadata:
      labels:
        app: rstudio                       # Must match the selector above
    spec:
      # ------------------------------------------------------------------------
      # Service Account
      # ------------------------------------------------------------------------
      serviceAccountName: secrets-reader-sa
      # This service account should be IRSA-enabled (AWS IAM Role for Service Account)
      # so that the container can securely call AWS Secrets Manager APIs without
      # embedding static IAM credentials.

      # ------------------------------------------------------------------------
      # Container Specification
      # ------------------------------------------------------------------------
      containers:
      - name: rstudio
        image: ${rstudio_image}            # Replace this placeholder with your image URI
        ports:
        - containerPort: 8787              # Default RStudio Server web interface port

        # ----------------------------------------------------------------------
        # Resource Requests & Limits
        # ----------------------------------------------------------------------
        # These values are tuned for t3.medium nodes (2 vCPU, 4 GiB memory).
        # The pod requests enough CPU and memory that only one can fit per node.
        resources:
          requests:
            cpu: "1200m"                   # Request ~1.2 vCPU
            memory: "2500Mi"               # Request ~2.5 GiB RAM
          limits:
            cpu: "2000m"                   # Allow up to full 2 vCPU burst
            memory: "3500Mi"               # Cap memory near node capacity
        # Notes:
        # - With these requests, each t3.medium node can fit only one RStudio pod.
        # - When CPU > 60%, the HPA below will add new pods, triggering node scale-up.

        # ----------------------------------------------------------------------
        # Secret Volume Mount (Configuration)
        # ----------------------------------------------------------------------
        volumeMounts:
        - name: rstudio-config-vol
          mountPath: /etc/rstudio-config
          readOnly: true                   # Prevent modification from within container

        # ----------------------------------------------------------------------
        # EFS Volume Mount (Persistent Home Directories)
        # ----------------------------------------------------------------------
        - name: efs-storage
          mountPath: /efs
        - name: efs-storage
          mountPath: /home
          subPath: home                    # Mount subdirectory for /home persistence

      # ------------------------------------------------------------------------
      # Volumes
      # ------------------------------------------------------------------------
      volumes:
      - name: rstudio-config-vol
        secret:
          secretName: rstudio-config       # Reference the Secret defined above
          defaultMode: 0440                # File permissions for mounted secret files
      - name: efs-storage
        persistentVolumeClaim:
          claimName: efs-claim             # Reference to the EFS PVC defined earlier
---
# --- Service ------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio-service
  labels:
    app: rstudio
spec:
  type: ClusterIP                          # Internal-only service type (no external IP)
  selector:
    app: rstudio
  ports:
  - port: 8787                             # Service port (inside cluster)
    targetPort: 8787                       # Pod port (exposed by container)
# Notes:
# - Used as the backend target for the Ingress below.
# - Within cluster, other services can connect via 'rstudio-service:8787'.
---
# --- Ingress ------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rstudio-ingress
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80}]'
    alb.ingress.kubernetes.io/healthcheck-path: /auth-sign-in
    alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=3600
    alb.ingress.kubernetes.io/target-group-attributes: >
      stickiness.enabled=true,
      stickiness.type=lb_cookie,
      stickiness.lb_cookie.duration_seconds=86400
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: rstudio-service
              port:
                number: 8787
# Notes:
# - The Ingress provisions an external ALB in AWS.
# - For HTTPS, attach an ACM certificate via annotation.
# - DNS can be managed via ExternalDNS to map rstudio.mikecloud.com to the ALB endpoint.
---
# --- Horizontal Pod Autoscaler (CPU-Based Scaling) ----------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rstudio-hpa
  labels:
    app: rstudio
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: rstudio
  minReplicas: 2                            # Keep at least two pods active
  maxReplicas: 4                            # Allow up to four pods total
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60            # Trigger scale-up when >60% CPU average
# Notes:
# - HPA increases replicas when average CPU usage exceeds 60%.
# - Cluster Autoscaler will then add nodes if necessary.
# - Scale-down below 2 pods is disabled to ensure high availability.
# ==============================================================================
